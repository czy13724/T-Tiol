name: 每日自动清空记录

on:
  # 1. 允许手动触发
  workflow_dispatch:
  
  # 2. 每日自动运行 (UTC 0:00 = 北京时间 8:00)
  schedule:
    - cron: '0 0 * * *'

jobs:
  delete-runs:
    runs-on: ubuntu-latest
    permissions:
      actions: write
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: 执行清理
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "开始清理旧的工作流记录..."
          
          # 获取所有非 'in_progress' (正在运行) 状态的记录 ID
          # --limit 1000: 每次处理 1000 条 (GitHub API 上限)
          # jq: 提取 ID
          # xargs: 传递给 delete 命令
          
          gh run list --limit 1000 --json databaseId,status \
            --jq 'map(select(.status != "in_progress")) | .[].databaseId' | \
          xargs -I {} gh run delete {}
          
          echo "清理完成！"
